<h1 class="mb-3">Edit Pre-plan · Load <%= @load.id %></h1>
<p class="text-muted"><%= @load.pickup_location %> → <%= @load.dropoff_location %></p>

<%= form_with url: preplan_load_path(@load), method: :get, local: true, class: "row g-2 align-items-end mb-3" do %>
  <div class="col-auto">
    <label class="form-label">Buffer (miles)</label>
    <%= number_field_tag :buffer, (@buffer || 15), min: 5, max: 50, step: 1, class: "form-control form-control-sm", style: "width:7rem" %>
  </div>

  <div class="col-auto">
    <label class="form-label">Min Truck Parking</label>
    <%= number_field_tag :min_parking, @min_parking, min: 0, step: 1,
          placeholder: "e.g. 20", class: "form-control form-control-sm", style: "width:7rem" %>
  </div>

  <div class="col-12">
    <label class="form-label me-2">Providers</label>
    <% [["Love's","Love's"],["Pilot","Pilot"],["Flying J","Flying J"],["TA","TA"],["Petro","Petro"],["AMBEST","AMBEST"],["Pilot Flying J","Pilot Flying J"]].each do |label,value| %>
      <div class="form-check form-check-inline">
        <%= check_box_tag "providers[]", value, Array(@providers).include?(value), class: "form-check-input", id: "prov_#{value.parameterize}" %>
        <label for="prov_<%= value.parameterize %>" class="form-check-label"><%= label %></label>
      </div>
    <% end %>
  </div>

  <div class="col-auto">
    <%= submit_tag "Update", class: "btn btn-secondary btn-sm" %>
    <%= link_to "Reset", preplan_load_path(@load), class: "btn btn-link btn-sm" %>
    <%= link_to "Back to Load", load_path(@load), class: "btn btn-link btn-sm" %>
  </div>
<% end %>

<p class="mb-3">
  <em>Found <%= @rest_areas_on_route&.size || 0 %> rest areas,
      <%= @weigh_stations_on_route&.size || 0 %> weigh stations,
      <%= @truck_stops_on_route&.size || 0 %> truck stops
      within <%= @buffer || 15 %> miles.</em>
</p>

<%= form_with url: add_stops_load_path(@load), method: :post, local: true do %>
  <div class="row gy-4">
    <!-- Truck Stops (selectable) -->
    <div class="col-12 col-lg-4">
      <h5 class="mb-2">Truck Stops</h5>
      <% if @truck_stops_on_route.present? %>
        <ul class="list-unstyled">
          <% @truck_stops_on_route.each do |truck_stop| %>
            <li class="mb-2">
              <div class="form-check">
                <%= check_box_tag "selected[]", "TruckStop-#{truck_stop.id}",
                    @selected_stop_keys.include?("TruckStop-#{truck_stop.id}"),
                    class: "form-check-input", id: "ts_#{truck_stop.id}" %>
                <label class="form-check-label" for="ts_<%= truck_stop.id %>">
                  <strong><%= truck_stop.name %></strong>
                  <%= provider_badge(truck_stop.provider) %><br>
                  <small class="text-muted">
                    <%= [truck_stop.street, truck_stop.city, truck_stop.state, truck_stop.zip_code].compact.join(", ") %>
                    <% if truck_stop.parking_truck.present? %> • Truck parking: <%= truck_stop.parking_truck %><% end %>
                    <% if defined?(truck_stop.miles_from_pickup) %>
                      • <%= number_with_precision(truck_stop.miles_from_pickup, precision: 1) %> mi from pickup
                      • <%= number_with_precision(truck_stop.miles_to_dropoff,  precision: 1) %> mi to drop-off
                    <% end %>
                  </small>
                </label>
              </div>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p class="text-muted">No truck stops. Try different filters.</p>
      <% end %>
    </div>

    <!-- Rest Areas (selectable) -->
    <div class="col-12 col-lg-4">
      <h5 class="mb-2">Rest Areas</h5>
      <% if @rest_areas_on_route.present? %>
        <ul class="list-unstyled">
          <% @rest_areas_on_route.each do |rest_area| %>
            <li class="mb-2">
              <div class="form-check">
                <%= check_box_tag "selected[]", "RestArea-#{rest_area.id}",
                    @selected_stop_keys.include?("RestArea-#{rest_area.id}"),
                    class: "form-check-input", id: "ra_#{rest_area.id}" %>
                <label class="form-check-label" for="ra_<%= rest_area.id %>">
                  <strong><%= rest_area.name.presence || "Rest Area" %></strong>
                  <small class="text-muted">
                    — <%= rest_area.state %> <%= rest_area.highway_route %>
                    <% if rest_area.respond_to?(:mile_post) && rest_area.mile_post.present? %> • MP <%= rest_area.mile_post %><% end %>
                    <% if rest_area.respond_to?(:number_of_spots) && rest_area.number_of_spots.present? %> • Spots: <%= rest_area.number_of_spots %><% end %>
                  </small>
                </label>
              </div>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p class="text-muted">No rest areas.</p>
      <% end %>
    </div>

    <!-- Weigh Stations (auto-included, NO checkboxes) -->
    <div class="col-12 col-lg-4">
      <h5 class="mb-2">Weigh Stations (auto-included)</h5>
      <% if @weigh_stations_on_route.present? %>
        <ul class="list-unstyled">
          <% @weigh_stations_on_route.each do |weigh_station| %>
            <li class="mb-2">
              <strong><%= weigh_station.name.presence || "Weigh Station" %></strong>
              <small class="text-muted">
                — <%= weigh_station.state %>
                <% if defined?(weigh_station.miles_from_pickup) %>
                  • <%= number_with_precision(weigh_station.miles_from_pickup, precision: 1) %> mi from pickup
                  • <%= number_with_precision(weigh_station.miles_to_dropoff,  precision: 1) %> mi to drop-off
                <% end %>
              </small>
            </li>
          <% end %>
        </ul>
        <p class="text-muted small">Weigh stations are always shown on the map and planned route.</p>
      <% else %>
        <p class="text-muted">No weigh stations.</p>
      <% end %>
    </div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <%= submit_tag "Save selected to this load", class: "btn btn-primary" %>
    <%= link_to "Back to Load", load_path(@load), class: "btn btn-outline-secondary" %>
  </div>
<% end %>
