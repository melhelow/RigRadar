<h1>Route Plan for Load <%= @load.id %></h1>

<p>
  <strong>Pickup:</strong> <%= @load.pickup_location %><br>
  <strong>Drop-off:</strong> <%= @load.dropoff_location %>
</p>

<%= form_with url: preplan_load_path(@load), method: :get, local: true do %>

  <div style="display:flex; gap:1rem; flex-wrap:wrap; align-items:flex-end;">
    <div>
      <label>Buffer (miles):</label>
      <%= number_field_tag :buffer, (@buffer || 15), min: 5, max: 50, step: 1 %>
    </div>

    <div>
      <label>Min Truck Parking</label>
      
      <%= number_field_tag :min_parking, (@min_parking || params[:min_parking]), min: 0, step: 1 %>

    </div>

    <div>
      <label>Providers</label><br>
    <% [["Love's","Love's"],["Pilot","Pilot"],["Flying J","Flying J"],["TA","TA"],["Petro","Petro"],["AMBEST","AMBEST"],["Pilot Flying J","Pilot Flying J"]].each do |label, value| %>
  <label style="margin-right:.5rem;">
    <%= check_box_tag "providers[]", value, Array(@providers || params[:providers]).include?(value) %> <%= label %>
        </label>
      <% end %>
    </div>

    <div>
      <%= submit_tag "Update", class: "btn btn-secondary" %>
      <%= link_to "Reset", plan_load_path(@load), class: "btn btn-link" %>
    </div>
  </div>
<% end %>

<p style="margin:.5rem 0;">
  <em>
    Found <%= @rest_areas_on_route&.size || 0 %> rest areas,
    <%= @weigh_stations_on_route&.size || 0 %> weigh stations, and
    <%= @truck_stops_on_route&.size || 0 %> truck stops within
    <%= @buffer || 15 %> miles.
  </em>
</p>

<p><%= link_to "Back to Load", load_path(@load), class: "btn" %></p>

<hr>

<%= form_with url: add_stops_load_path(@load), method: :post, local: true do %>
  <div style="display:flex; gap:2rem; align-items:flex-start; flex-wrap:wrap;">

    <!-- Truck Stops -->
    <div style="flex:1; min-width:280px;">
      <h3>Truck Stops</h3>
      <% if @truck_stops_on_route.present? %>
        <ul>
          <% @truck_stops_on_route.each do |truck_stop| %>
            <li style="margin:.4rem 0;">
              <label>
                <%= check_box_tag "selected[]", "TruckStop-#{truck_stop.id}",
                  @selected_stop_keys.include?("TruckStop-#{truck_stop.id}") %>
                <strong><%= truck_stop.name %></strong> <%= provider_badge(truck_stop.provider) %><br>
                <small>
                  <%= [truck_stop.street, truck_stop.city, truck_stop.state, truck_stop.zip_code].compact.join(", ") %>
                  <% if truck_stop.parking_truck.present? %> • Truck parking: <%= truck_stop.parking_truck %><% end %>
                  <% if truck_stop.opening_hours.present? %> • Hours: <%= truck_stop.opening_hours %><% end %>
                  <% if truck_stop.website.present? %> • <a href="<%= truck_stop.website %>" target="_blank" rel="noopener">Website</a><% end %>
                  <% if truck_stop.direction_url.present? %> • <a href="<%= truck_stop.direction_url %>" target="_blank" rel="noopener">Directions</a><% end %>
                  <% if defined?(truck_stop.miles_from_pickup) %>
                  • <%= number_with_precision(truck_stop.miles_from_pickup, precision: 1) %> mi from pickup
                  • <%= number_with_precision(truck_stop.miles_to_dropoff,  precision: 1) %> mi to drop-off
                <% end %>

                </small>
              </label>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p>No truck stops in this corridor. Try a larger buffer or different filters.</p>
      <% end %>
    </div>

    <!-- Rest Areas -->
    <div style="flex:1; min-width:280px;">
      <h3>Rest Areas</h3>
      <% if @rest_areas_on_route.present? %>
        <ul>
          <% @rest_areas_on_route.each do |rest_area| %>
            <li>
              <label>
                <%= check_box_tag "selected[]", "RestArea-#{rest_area.id}",
                  @selected_stop_keys.include?("RestArea-#{rest_area.id}") %>
                <strong><%= rest_area.name.presence || "Rest Area" %></strong>
                <small>
                  — <%= rest_area.state %> <%= rest_area.highway_route %>
                  <% if rest_area.respond_to?(:mile_post) && rest_area.mile_post.present? %> • MP <%= rest_area.mile_post %><% end %>
                  <% if rest_area.respond_to?(:number_of_spots) && rest_area.number_of_spots.present? %> • Spots: <%= rest_area.number_of_spots %><% end %>
                  <% if defined?(rest_area.miles_from_pickup) %>
                  • <%= number_with_precision(rest_area.miles_from_pickup, precision: 1) %> mi from pickup
                  • <%= number_with_precision(rest_area.miles_to_dropoff,  precision: 1) %> mi to drop-off
                <% end %>

                </small>
              </label>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p>No rest areas in this corridor. Try a larger buffer.</p>
      <% end %>
    </div>

    
    <div style="flex:1; min-width:280px;">
      <h3>Weigh Stations</h3>
      <% if @weigh_stations_on_route.present? %>
        <ul>
          <% @weigh_stations_on_route.each do |weigh_station| %>
            <li>
              <label>
                <%= check_box_tag "selected[]", "WeighStation-#{weigh_station.id}",
                  @selected_stop_keys.include?("WeighStation-#{weigh_station.id}") %>
                <strong><%= weigh_station.name.presence || "Weigh Station" %></strong>
                <small> — <%= weigh_station.state %>
                   <% if defined?(weigh_station.miles_from_pickup) %>
                    • <%= number_with_precision(weigh_station.miles_from_pickup, precision: 1) %> mi from pickup
                    • <%= number_with_precision(weigh_station.miles_to_dropoff,  precision: 1) %> mi to drop-off
                  <% end %>

                </small>
              </label>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p>No weigh stations in this corridor. Try a larger buffer.</p>
      <% end %>
    </div>

  </div>

  <div style="margin-top:1rem;">
    <%= submit_tag "Save selected stops to this load", class: "btn btn-primary" %>
    <%= link_to "Back to Load", load_path(@load), class: "btn" %>
  </div>
<% end %>
