
<div class="card card-soft mb-4">
  <div class="card-body">
    <%= form_with url: preplan_load_path(@load), method: :get, local: true do %>
      <div class="row g-3 align-items-end">
        <div class="col-sm-3">
          <%= label_tag :buffer, "Buffer (miles)", class: "form-label" %>
          <%= number_field_tag :buffer, (@buffer || 15), min: 5, max: 50, step: 1, class: "form-control" %>
        </div>

        <div class="col-sm-3">
          <%= label_tag :min_parking, "Min Truck Parking", class: "form-label" %>
          <%= number_field_tag :min_parking, params[:min_parking], min: 0, step: 1, placeholder: "e.g. 20", class: "form-control" %>
        </div>

        <div class="col-12">
          <label class="form-label">Providers</label>
          <div class="d-flex flex-wrap gap-3">
            <% ["Love's","Pilot","Flying J","TA","Petro","AMBEST"].each do |label| %>
              <% id = "prov_#{label.parameterize}" %>
              <div class="form-check">
                <%= check_box_tag "providers[]", label, Array(params[:providers]).include?(label),
                    id: id, class: "form-check-input" %>
                <%= label_tag id, label, class: "form-check-label" %>
              </div>
            <% end %>
          </div>
        </div>

        <div class="col-auto">
          <%= submit_tag "Update", class: "btn btn-rr" %>
          <%= link_to "Reset", preplan_load_path(@load), class: "btn btn-link" %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<p class="text-muted mb-3">
  <em>
    Found <%= @rest_areas_on_route&.size || 0 %> rest areas,
    <%= @weigh_stations_on_route&.size || 0 %> weigh stations,
    and <%= @truck_stops_on_route&.size || 0 %> truck stops within <%= @buffer || 15 %> miles.
  </em>
</p>


<%= form_with url: add_stops_load_path(@load), method: :post, local: true do %>
<%# NOTE: For better security, we'd love to see the field currently using hidden_tag implemented in a more secure way, as hidden fields can still be manipulated by a user. %>
<%= hidden_field_tag :buffer, (@buffer || 15) %>

  <div class="row row-cols-1 row-cols-md-3 g-4">
    <div class="col">
      <div class="card card-soft h-100">
        <div class="card-header fw-semibold">Truck Stops</div>
        <div class="card-body">
          <% if @truck_stops_on_route.present? %>
            <div class="list-group">
              <% @truck_stops_on_route.each do |truck_stop| %>
                <label class="list-group-item">
                  <div class="form-check">
                    <%= check_box_tag "selected[]", "TruckStop-#{truck_stop.id}",
            @selected_stop_keys.include?("TruckStop-#{truck_stop.id}"),
            class: "form-check-input me-2" %>
                    <span class="fw-semibold"><%= truck_stop.name %></span>
                    <% if truck_stop.provider.present? %>
                      <span class="badge text-bg-primary ms-2"><%= truck_stop.provider %></span>
                    <% end %>
                  </div>
                  <div class="small text-muted mt-1">
                    <%= [truck_stop.street, truck_stop.city, truck_stop.state, truck_stop.zip_code].compact.join(", ") %>
                    <% if truck_stop.parking_truck.present? %> • Truck parking: <%= truck_stop.parking_truck %><% end %>
                    <% if truck_stop.opening_hours.present? %> • Hours: <%= truck_stop.opening_hours %><% end %>
                    <% if truck_stop.website.present? %> • <a href="<%= truck_stop.website %>" target="_blank" rel="noopener">Website</a><% end %>
                    <% if truck_stop.direction_url.present? %> • <a href="<%= truck_stop.direction_url %>" target="_blank" rel="noopener">Directions</a><% end %>
                    
                    <% if defined?(truck_stop.miles_from_pickup) %>
                      <span class="text-danger fw-semibold">
                        <%= number_with_precision(truck_stop.miles_from_pickup, precision: 1) %> mi from pickup
                       <%= number_with_precision(truck_stop.miles_to_dropoff,  precision: 1) %> mi to drop-off
                      </span>
                    <% end %>

                  </div>
                </label>
              <% end %>
            </div>

          <% else %>
            <div class="text-muted">No truck stops in this route.</div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card card-soft h-100">
        <div class="card-header fw-semibold">Rest Areas</div>
        <div class="card-body">
          <% if @rest_areas_on_route.present? %>
            <div class="list-group">
              <% @rest_areas_on_route.each do |rest_area| %>
                <label class="list-group-item">
                  <div class="form-check">
                    <%= check_box_tag "selected[]", "RestArea-#{rest_area.id}",
            @selected_stop_keys.include?("RestArea-#{rest_area.id}"),
            class: "form-check-input me-2" %>
                    <span class="fw-semibold"><%= rest_area.name.presence || "Rest Area" %></span>
                  </div>
                  <div class="small text-muted mt-1">
                    <%= rest_area.state %> <%= rest_area.highway_route %>
                    <% if rest_area.respond_to?(:mile_post) && rest_area.mile_post.present? %>  MP <%= rest_area.mile_post %><% end %>
                    <% if rest_area.respond_to?(:number_of_spots) && rest_area.number_of_spots.present? %> • Spots: <%= rest_area.number_of_spots %><% end %>

                       <% if defined?(rest_area.miles_from_pickup) %>
                        <span class="text-danger fw-semibold">
                          <%= number_with_precision(rest_area.miles_from_pickup, precision: 1) %> mi from pickup
                         <%= number_with_precision(rest_area.miles_to_dropoff,  precision: 1) %> mi to drop-off
                        </span>
                      <% end %>

                  </div>
                </label>
              <% end %>
            </div>

          <% else %>
            <div class="text-muted">No rest areas in this route.</div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card card-soft h-100">
        <div class="card-header fw-semibold">Weigh Stations</div>
        <div class="card-body">
          <% if @weigh_stations_on_route.present? %>
            <div class="list-group">
              <% @weigh_stations_on_route.each do |weigh_station| %>
                <div class="list-group-item">
                  <strong><%= weigh_station.name.presence || "Weigh Station" %></strong>
                  <div class="small text-muted mt-1">
                     <%= weigh_station.state %>
                    <% if defined?(weigh_station.miles_from_pickup) %>
                    <span class="text-danger fw-semibold">
                      <%= number_with_precision(weigh_station.miles_from_pickup, precision: 1) %> mi from pickup
                      <%= number_with_precision(weigh_station.miles_to_dropoff,  precision: 1) %> mi to drop-off
                    </span>
                  <% end %>

                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-muted">No weigh stations in this route.</div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-4 d-flex gap-2">
    <%= submit_tag "Save selected stops to this load", class: "btn btn-rr" %>
    <%= link_to "Back to Load", load_path(@load), class: "btn btn-light" %>
  </div>
<% end %>
